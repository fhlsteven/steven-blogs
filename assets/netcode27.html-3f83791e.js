import{_ as t,r as p,o,c,b as n,d as s,e,a as u}from"./app-a2b6e588.js";const l="data:image/gif;base64,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",k={},i={id:"c-网络编程之tcp篇",tabindex:"-1"},r=n("a",{class:"header-anchor",href:"#c-网络编程之tcp篇","aria-hidden":"true"},"#",-1),m={href:"https://www.cnblogs.com/tengguo/archive/2011/12/30/2307665.html",target:"_blank",rel:"noopener noreferrer"},d=u('<p>前一篇<a href="./net_soc/netsoc19">《Visual C#.Net网络程序开发-Socket篇》</a>中说到：支持Http、Tcp和Udp的类组成了TCP/IP三层模型(请求响应层、应用协议层、传输层)的中间层-应用协议层，该层的类比位于最底层的Socket类提供了更高层次的抽象，它们封装 TCP 和 UDP 套接字的创建，不需要处理连接的细节，这使得我们在编写套接字级别的协议时，可以更多地尝试使用 <code>TCPClient</code>、<code>UDPClient</code>和<code>TcpListener</code>，而不是直接向 Socket 中写。它们之间的这种层次关系示意如下：</p><p><img src="'+l+`" alt="netcode27_1"></p><p>可见，TcpClient 类基于 Socket 类构建，这是它能够以更高的抽象程度提供 TCP 服务的基础。正因为这样，许多应用层上的通讯协议，比如FTP(File Transfers Protocol)文件传输协议、HTTP(Hypertext Transfers Protocol)超文本传输协议等都直接创建在TcpClient等类之上。</p><p>TCPClient 类使用 TCP 从 Internet 资源请求数据。TCP 协议建立与远程终结点的连接，然后使用此连接发送和接收数据包。TCP 负责确保将数据包发送到终结点并在数据包到达时以正确的顺序对其进行组合。</p><p>从名字上就可以看出，TcpClient类专为客户端设计，它为 TCP 网络服务提供客户端连接。TcpClient 提供了通过网络连接、发送和接收数据的简单方法。</p><p>若要建立 TCP 连接，必须知道承载所需服务的网络设备的地址(IPAddress)以及该服务用于通讯的 TCP 端口 (Port)。Internet 分配号码机构 (Internet Assigned Numbers Authority, IANA) 定义公共服务的端口号（你可以访问 <code>http://www.iana.org/assignments/port-numbers</code> 获得这方面更详细的资料）。IANA 列表中所没有的服务可使用 1,024 到 65,535 这一范围中的端口号。要创建这种连接，你可以选用TcpClient类的三种构造函数之一：</p><p>1、public TcpClient()当使用这种不带任何参数的构造函数时，将使用本机默认的ip地址并将使用默认的通信端口号0。这样情况下，如果本机不止一个ip地址，将无法选择使用。以下语句示例了如何使用默认构造函数来创建新的 TcpClient：</p><p><code>TcpClient tcpClientC = new TcpClient();</code></p><p>2、 public TcpClient(IPEndPoint) 使用本机IPEndPoint创建TcpClient的实例对象。上一篇介绍过了，IPEndPoint将网络端点表示为IP地址和端口号，在这里它用于指定在建立远程主机连接时所使用的本地网络接口（IP 地址）和端口号，这个构造方法为使用本机IPAddress和Port提供了选择余地。下面的语句示例了如何使用本地终结点创建 TcpClient 类的实例：</p><div class="language-csharp" data-ext="cs"><pre class="language-csharp"><code><span class="token class-name">IPHostEntry</span> ipInfo<span class="token operator">=</span>Dns<span class="token punctuation">.</span><span class="token function">GetHostByName</span><span class="token punctuation">(</span><span class="token string">&quot;www.tuha.net&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主机信息</span>
<span class="token class-name">IPAddressList<span class="token punctuation">[</span><span class="token punctuation">]</span></span> ipList<span class="token operator">=</span>ipInfo<span class="token punctuation">.</span>AddressList<span class="token punctuation">;</span>  <span class="token comment">//IP地址数组</span>
<span class="token class-name">IPAddress</span> ip<span class="token operator">=</span>ipList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                     <span class="token comment">//多IP地址时一般用第一个</span>
<span class="token class-name">IPEndPoint</span> ipEP<span class="token operator">=</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">IPEndPoint</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span><span class="token number">4088</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//得到网络终结点</span>
<span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token class-name">TcpClient</span> tcpClientA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TcpClient</span><span class="token punctuation">(</span>ipLocalEndPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到这里，你可能会感到困惑，客户端要和服务端创建连接，所指定的IP地址及通信端口号应该是远程服务器的呀！事实上的确如此，使用以上两种构造函数，你所实现的只是TcpClient实例对象与IP地址和Port端口的绑定，要完成连接，你还需要显式指定与远程主机的连接，这可以通过TcpClient类的Connect方法来实现， Connet方法使用指定的主机名和端口号将客户端连接到 远程主机：</p><ul><li><code>public void Connect(IPEndPoint);</code> 使用指定的远程网络终结点将客户端连接到远程 TCP 主机。</li><li><code>public void Connect(IPAddress, int);</code> 使用指定的 IP 地址和端口号将客户端连接到 TCP 主机。</li><li><code>public void Connect(string, int);</code> 将客户端连接到指定主机上的指定端口。</li></ul><p>需要指出的是，Connect方法的所有重载形式中的参数IPEndPoint网络终结点、IPAddress以及表现为string的Dns主机名和int指出的Port端口均指的是远程服务器。</p><p>以下示例语句使用主机默认IP和Port端口号0与远程主机建立连接：</p><div class="language-csharp" data-ext="cs"><pre class="language-csharp"><code><span class="token class-name">TcpClient</span> tcpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建TcpClient对象实例</span>
<span class="token keyword">try</span><span class="token punctuation">{</span>
    tcpClient<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;www.contoso.com&quot;</span><span class="token punctuation">,</span><span class="token number">11002</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//建立连接</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e <span class="token punctuation">)</span><span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>3、<code>public TcpClient(string, int);</code></p><p>初始化 TcpClient 类的新实例并连接到指定主机上的指定端口。与前两个构造函数不一样，这个构造函数将自动建立连接，你不再需要额外调用Connect方法，其中string类型的参数表示远程主机的Dns名，如：www.tuha.net。</p><p>以下示例语句调用这一方法实现与指定主机名和端口号的主机相连：</p><div class="language-csharp" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token class-name">TcpClient</span> tcpClientB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TcpClient</span><span class="token punctuation">(</span><span class="token string">&quot;www.tuha.net&quot;</span><span class="token punctuation">,</span> <span class="token number">4088</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>前面我们说,TcpClient类创建在Socket之上，在Tcp服务方面提供了更高层次的抽象,体现在网络数据的发送和接受方面,是TcpClient使用标准的Stream流处理技术，使得它读写数据更加方便直观，同时，.Net框架负责提供更丰富的结构来处理流，贯穿于整个.Net框架中的流具有更广泛的兼容性，构建在更一般化的流操作上的通用方法使我们不再需要困惑于文件的实际内容（HTML、XML 或其他任何内容），应用程序都将使用一致的方法（Stream.Write、Stream.Read） 发送和接收数据。另外，流在数据从 Internet 下载的过程中提供对数据的即时访问，可以在部分数据到达时立即开始处理，而不需要等待应用程序下载完整个数据集。.Net中通过NetworkStream类实现了这些处理技术。</p><p>NetworkStream 类包含在.Net框架的System.Net.Sockets 命名空间里，该类专门提供用于网络访问的基础数据流。NetworkStream 实现通过网络套接字发送和接收数据的标准.Net 框架流机制。NetworkStream 支持对网络数据流的同步和异步访问。NetworkStream 从 Stream 继承，后者提供了一组丰富的用于方便网络通讯的方法和属性。</p><p>同其它继承自抽象基类Stream的所有流一样，NetworkStream网络流也可以被视为一个数据通道，架设在数据来源端(客户Client)和接收端（服务Server）之间，而后的数据读取及写入均针对这个通道来进行。</p><p>.Net框架中，NetworkStream流支持两方面的操作：</p><p>1、 写入流。写入是从数据结构到流的数据传输。</p><p>2、读取流。读取是从流到数据结构（如字节数组）的数据传输。</p><p>与普通流Stream不同的是，网络流没有当前位置的统一概念，因此不支持查找和对数据流的随机访问。相应属性CanSeek 始终返回 false，而 Seek 和 Position 方法也将引发 NotSupportedException。</p><p>基于Socket上的应用协议方面，你可以通过以下两种方式获取NetworkStream网络数据流：</p><p>1、使用NetworkStream构造函数：public NetworkStream(Socket, FileAccess, bool);（有重载方法）,它用指定的访问权限和指定的 Socket 所属权为指定的 Socket 创建 NetworkStream 类的新实例，使用前你需要创建Socket对象实例，并通过Socket.Connect方法建立与远程服务端的连接，而后才可以使用该方法得到网络传输流。示例如下：</p><div class="language-csharp" data-ext="cs"><pre class="language-csharp"><code><span class="token class-name">Socket</span> s<span class="token operator">=</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span>SocketType<span class="token punctuation">.</span>Stream<span class="token punctuation">,</span>ProtocolType<span class="token punctuation">.</span>Tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建客户端Socket对象实例</span>
<span class="token keyword">try</span><span class="token punctuation">{</span>
    s<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;www.tuha.net&quot;</span><span class="token punctuation">,</span><span class="token number">4088</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//建立与远程主机的连接</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    MessageBox<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token string">&quot;连接错误：&quot;</span> <span class="token operator">+</span>e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token class-name">NetworkStream</span> stream<span class="token operator">=</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">NetworkStream</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>FileAccess<span class="token punctuation">.</span>ReadWrite<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取得网络传输流</span>
<span class="token punctuation">}</span>
</code></pre></div><p>2、通过TcpClient.GetStream方法：<code>public NetworkStream GetStream();</code>它返回用于发送和接收数据的基础网络流NetworkStream。GetStream 通过将基础 Socket 用作它的构造函数参数来创建 NetworkStream 类的实例。使用前你需要先创TcpClient对象实例并建立与远程主机的连接，示例如下：</p><div class="language-csharp" data-ext="cs"><pre class="language-csharp"><code><span class="token class-name">TcpClient</span> tcpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建TcpClient对象实例</span>
Try<span class="token punctuation">{</span>
    tcpClient<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">&quot;www.tuha.net&quot;</span><span class="token punctuation">,</span><span class="token number">4088</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//尝试与远程主机相连</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">&quot;连接错误:&quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token class-name">NetworkStream</span> stream<span class="token operator">=</span>tcpClient<span class="token punctuation">.</span><span class="token function">GetStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取网络传输流</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">&quot;TcpClient错误：&quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过以上方法得到NetworkStream网络流之后,你就可以使用标准流读写方法Write和Read来发送和接受数据了。</p><p>以上是.Net下使用TcpClient类实现客户端编程的技术资料，为了向客户端提供这些服务，我们还需要编制相应的服务端程序，前一篇《Visual C#.Net网络程序开发-Socket篇》上曾经提到， Socket作为其他网络协议的基础，既可以面向客户端开发，也可以面向服务端开发，在传输层面上使用较多，而在应用协议层面上，客户端我们采用构建于Socket类之上的TcpClient取代Socket；相应地，构建于Socket之上的TcpListener提供了更高理念级别的 TCP 服务，使得我们能更方便地编写服务端应用程序。正是因为这样的原因，像FTP 和 HTTP 这样的应用层协议都是在 TcpListener 类的基础上建立的。</p><p>.Net中的TCPListener 用于监视TCP 端口上的传入请求，通过绑定本机IP地址和相应端口（这两者应与客户端的请求一致）创建TcpListener对象实例,并由Start方法启动侦听；当TcpListener侦听到用户端的连接后，视客户端的不同请求方式，通过AcceptTcpClient 方法接受传入的连接请求并创建 TcpClient 以处理请求，或者通过AcceptSocket 方法接受传入的连接请求并创建 Socket 以处理请求。最后，你需要使用 Stop 关闭用于侦听传入连接的 Socket，你必须也关闭从 AcceptSocket 或 AcceptTcpClient 返回的任何实例。这个过程详细解说如下：</p><p>首先，创建TcpListener对象实例，这通过TcpListener类的构造方法来实现：</p><div class="language-csharp" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token function">TcpListener</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//指定本机端口</span>
<span class="token keyword">public</span> <span class="token function">TcpListener</span><span class="token punctuation">(</span>IPEndPoint<span class="token punctuation">)</span><span class="token comment">//指定本机终结点</span>
<span class="token keyword">public</span> <span class="token function">TcpListener</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token comment">//指定本机IP地址及端口</span>
</code></pre></div><p>以上方法中的参数在前面多次提到，这里不再细述，唯一需要提醒的是，这些参数均针对服务端主机。下面的示例演示创建 TcpListener 类的实例：</p><div class="language-csharp" data-ext="cs"><pre class="language-csharp"><code><span class="token class-name">IPHostEntry</span> ipInfo<span class="token operator">=</span>Dns<span class="token punctuation">.</span><span class="token function">Resolve</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主机信息</span>
<span class="token class-name">IPAddressList<span class="token punctuation">[</span><span class="token punctuation">]</span></span> ipList<span class="token operator">=</span>ipInfo<span class="token punctuation">.</span>IPAddressList<span class="token punctuation">;</span><span class="token comment">//IP数组</span>
<span class="token class-name">IPAddress</span> ip<span class="token operator">=</span>ipList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//IP</span>
<span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token class-name">TcpListener</span> tcpListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TcpListener</span><span class="token punctuation">(</span>ipAddress<span class="token punctuation">,</span> <span class="token number">4088</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建TcpListener对象实例以侦听用户端连接</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">&quot;TcpListener错误：&quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>随后，你需要调用Start方法启动侦听：</p><p><code>public void Start();</code></p><p>其次，当侦听到有用户端连接时，需要接受挂起的连接请求，这通过调用以下两方法之一来完成连接：</p><div class="language-csharp" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">Socket</span> <span class="token function">AcceptSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token return-type class-name">TcpClient</span> <span class="token function">AcceptTcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>前一个方法返回代表客户端的Socket对象，随后可以通过Socket 类的 Send 和 Receive 方法与远程计算机通讯；后一个方法返回代表客户端的TcpClient对象，随后使用上面介绍的 TcpClient.GetStream 方法获取 TcpClient 的基础网络流 NetworkStream，并使用流读写Read/Write方法与远程计算机通讯。</p><p>最后，请记住关闭侦听器：<code>public void Stop();</code></p><p>同时关闭其他连接实例：<code>public void Close();</code> 　　 下面的示例完整体现了上面的过程：</p><div class="language-csharp" data-ext="cs"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">bool</span></span> done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token class-name">TcpListener</span> listener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TcpListener</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建TcpListener对象实例(13号端口提供时间服务)</span>
listener<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动侦听</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//进入无限循环以侦听用户连接</span>
    <span class="token class-name">TcpClient</span> client <span class="token operator">=</span> listener<span class="token punctuation">.</span><span class="token function">AcceptTcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//侦听到连接后创建客户端连接TcpClient</span>
    <span class="token class-name">NetworkStream</span> ns <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">GetStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到网络传输流</span>
    <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> byteTime <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>ASCII<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//预发送的内容(此为服务端时间)转换为字节数组以便写入流</span>
    
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
    ns<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>byteTime<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> byteTime<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写入流</span>
    ns<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭流</span>
    client<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭客户端连接</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">&quot;流错误:&quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>综合运用上面的知识，下面的实例实现了简单的网络通讯-双机互连，针对客户端和服务端分别编制了应用程序。客户端创建到服务端的连接，向远程主机发送连接请求连接信号，并发送交谈内容；远程主机端接收来自客户的连接，向客户端发回确认连接的信号，同时接收并显示客户端的交谈内容。在这个基础上，发挥你的创造力，你完全可以开发出一个基于程序语言(C#)级的聊天室！</p><p>客户端主要源代码：</p><div class="language-csharp" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SendMeg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//发送信息</span>
<span class="token punctuation">{</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">int</span></span> port<span class="token operator">=</span>Int32<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>textBox3<span class="token punctuation">.</span>Text<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//远程主机端口</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            tcpClient<span class="token operator">=</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">TcpClient</span><span class="token punctuation">(</span>textBox1<span class="token punctuation">.</span>Text<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建TcpClient对象实例 </span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> le<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">&quot;TcpClient Error:&quot;</span><span class="token operator">+</span>le<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name"><span class="token keyword">string</span></span> strDateLine<span class="token operator">=</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">ToShortDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot; &quot;</span><span class="token operator">+</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">ToLongTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到发送时客户端时间</span>
        netStream<span class="token operator">=</span>tcpClient<span class="token punctuation">.</span><span class="token function">GetStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到网络流</span>
        sw<span class="token operator">=</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamWriter</span><span class="token punctuation">(</span>netStream<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建TextWriter,向流中写字符</span>

        <span class="token class-name"><span class="token keyword">string</span></span> words<span class="token operator">=</span>textBox4<span class="token punctuation">.</span>Text<span class="token punctuation">;</span><span class="token comment">//待发送的话</span>
        <span class="token class-name"><span class="token keyword">string</span></span> content<span class="token operator">=</span>strDateLine<span class="token operator">+</span>words<span class="token punctuation">;</span><span class="token comment">//待发送内容</span>

        sw<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写入流</span>
        sw<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭流写入器</span>
        netStream<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭网络流</span>
        tcpClient<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭客户端连接</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">&quot;Sending Message Failed!&quot;</span><span class="token operator">+</span>ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    textBox4<span class="token punctuation">.</span>Text<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span><span class="token comment">//清空</span>
<span class="token punctuation">}</span>
</code></pre></div><p>服务器端主要源代码：</p><div class="language-csharp" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">StartListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//侦听特定端口的用户请求</span>
<span class="token punctuation">{</span>
    <span class="token comment">//ReceiveMeg();</span>
    isLinked<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//连接标志</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">int</span></span> port<span class="token operator">=</span>Int32<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>textBox1<span class="token punctuation">.</span>Text<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//本地待侦听端口</span>
        serverListener<span class="token operator">=</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">TcpListener</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建TcpListener对象实例</span>
        serverListener<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//启动侦听</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">&quot;Can‘t Start Server&quot;</span><span class="token operator">+</span>ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    isLinked<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment">//进入无限循环等待用户端连接</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            tcpClient<span class="token operator">=</span>serverListener<span class="token punctuation">.</span><span class="token function">AcceptTcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建客户端连接对象</span>
            netStream<span class="token operator">=</span>tcpClient<span class="token punctuation">.</span><span class="token function">GetStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到网络流</span>
            sr<span class="token operator">=</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamReader</span><span class="token punctuation">(</span>netStream<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//流读写器</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> re<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name"><span class="token keyword">string</span></span> buffer<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">string</span></span> received<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        received<span class="token operator">+=</span>sr<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读流中一行</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>received<span class="token punctuation">.</span>Length<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            buffer<span class="token operator">+=</span>received<span class="token punctuation">;</span>
            buffer<span class="token operator">+=</span><span class="token string">&quot;\\r\\n&quot;</span><span class="token punctuation">;</span>
            <span class="token comment">//received=&quot;&quot;;</span>
            received<span class="token operator">=</span>sr<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        listBox1<span class="token punctuation">.</span>Items<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//显示</span>
        <span class="token comment">//关闭</span>
        sr<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        netStream<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tcpClient<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>`,51);function S(w,C){const a=p("ExternalLinkIcon");return o(),c("div",null,[n("h1",i,[r,s(),n("a",m,[s("C#网络编程之TCP篇"),e(a)])]),d])}const g=t(k,[["render",S],["__file","netcode27.html.vue"]]);export{g as default};
