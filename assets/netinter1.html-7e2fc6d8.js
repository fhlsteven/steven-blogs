import{_ as n,o as s,c as a,a as p}from"./app-f0851ed3.js";const o="/steven-blogs/assets/netinter1_1-8eabb034.jpg",t="/steven-blogs/assets/netinter1_2-bdaf85fd.jpg",e="/steven-blogs/assets/netinter1_3-29dc7bd9.jpg",c="/steven-blogs/assets/netinter1_4-687227b2.jpg",k="/steven-blogs/assets/netinter1_5-a519f89e.jpg",l="/steven-blogs/assets/netinter1_6-4832c8a3.jpg",r="/steven-blogs/assets/netinter1_7-ad3e9743.jpg",u="/steven-blogs/assets/netinter1_8-c72c162b.jpg",i={},d=p('<h1 id="自动上网的机器人自动抓数据" tabindex="-1"><a class="header-anchor" href="#自动上网的机器人自动抓数据" aria-hidden="true">#</a> 自动上网的机器人自动抓数据</h1><blockquote><p>hsn1982（收藏） 关键字:WebBrowser,拨号</p></blockquote><p>在大多数情况下，上网冲浪是件令人愉快的事情。但若是数百上千的超链接摆在你面前，而你又不得不一一点击这些链接、进入相应的网页、手工筛选出每页里你需要的信息、最后再将这些信息编进数据库中、....，你将做何感想？如果每天都从事这种繁杂、枯燥的工作会不会让你发疯?</p><p>“自动上网机器人”或许可救你出“苦海”：你可以喝着咖啡、听着音乐、看着“机器人”辛勤地替你工作，那感觉是不是棒极了！</p><p>本文结合实例详尽讨论了用VB实现“上网机器人”的技术细节。我们知道，搜集和下载资料是人们使用互联网的最主要的目的之一，但有些信息资源过于庞大，用手工摘取的方法是困难的或根本就是行不通的。例如，你需要搜集欧洲进口机械设备的公司名录以便给他们发信邀请其参加博览会，在网上找到这些信息并不难，但出于数据安全等方面的考虑，几乎所有提供类似信息的网站都没有提供直接下载数据的功能。</p><p>要想搜集齐想要的数据，唯一可用的方法就是一页一页地浏览每个公司的信息页，摘取其中有用的数据并存入数据库。但当公司总数超过数千时，巨大的工作量会让任何人望而却步！其实，这浩大的工作完全可以由程序来完成，因为这些任务完全是机械的重复性工作。而且，用程序完成比用手工要快得多。本文涉及的技术细节是通用的，即对实例程序稍加修改就可完成任何“自动上网冲浪”任务。</p><p>自动拨号上网、自动处理中途掉线、任务完成后自动挂断，这些都是“上网机器人”的最基本的功能之一。它还能给你带来明显的经济回报：如果你让“机器人”在晚间至凌晨的上网费优惠期内拨号上网去自动冲浪，那真可称得上是典型的“一石三鸟”----你睡觉、它工作、还省钱！有关这方面的细节将在本文的第三部分里讨论。该部分提供了实现上述各功能的若干方法，并比较了这些方法各自的优劣。</p><p>本文的第一和第二部分分别以两个实例讨论了自动浏览的技术细节：在网页上的输入区内自动填入数据以便完成诸如用户登录等的操作、自动更新CheckBox、自动选择下拉式列表（ComboBox）的值、自动点击网页上的按钮、从网页上精确提取有用的数据并存盘、将网页上二维表（Table）内的数据一一提取出来并转换且存储成可直接导入数据库或 Excel的格式，以及控制浏览进程的技巧等等。</p><h2 id="第一部分-从网页上精确提取数据" tabindex="-1"><a class="header-anchor" href="#第一部分-从网页上精确提取数据" aria-hidden="true">#</a> 第一部分 从网页上精确提取数据</h2><p><img src="'+o+'" alt="net_1"></p><p>本部分的实例是：下载沪深两市全部约1100家个股的基本信息及财务数据。若用手工操作，如上图所示，需要在股票代码区内分别输入1100个股票代码，在下拉式列表（ComboBox）中分别选择“个股资料”和“财务数据解读”，算下来约是2200次操作！这样的工作当然是由程序来完成划算得多。况且手工提取数据（先选中、再使用Ctrl+C拷贝）极容易出错（多选或漏选），又很费眼神。</p><h3 id="_1-在输入区内自动填入数据" tabindex="-1"><a class="header-anchor" href="#_1-在输入区内自动填入数据" aria-hidden="true">#</a> 1. 在输入区内自动填入数据</h3><p>为使程序能高效地自动浏览，需引入一些最基本的功能，如在输入区内自动填入数据、自动点击按钮等等。虽然用变换 URL地址的方法有时也能完成任务，但往往过于费力，尤其当网页上的输入区较多时更是如此。</p><p>为了在输入区内输入数据，需要先搜索到该对象的名字，然后将该对象的值置为要填入的数据即可。搜索名字的工作可编程完成，亦可用 FrontPage轻松获得。</p><h3 id="_2-自动在下拉式列表-combobox-中进行选择" tabindex="-1"><a class="header-anchor" href="#_2-自动在下拉式列表-combobox-中进行选择" aria-hidden="true">#</a> 2. 自动在下拉式列表（ComboBox）中进行选择</h3><p>同样地，首先要获得下拉式列表的名字。然后根据下拉式列表的元素总数（length属性）在列表中搜索要设置的值（列表的 Options集合中元素的Text属性），找到后，将该元素设为选中元素（元素的Selected属性）。</p><h3 id="_3-自动点击按钮" tabindex="-1"><a class="header-anchor" href="#_3-自动点击按钮" aria-hidden="true">#</a> 3. 自动点击按钮</h3><p>对于按钮来讲，可根据其名字访问，亦可根据其值访问。按钮的值就是显示在按钮上的文字。一个按钮可能没有名字，但一定有值。本例的程序就是根据值来访问按钮。执行按钮的 Click方法就相当于点击了该按钮。</p><p><img src="'+t+`" alt="netinter1_2"></p><p>图二中红色箭头所指即为程序自动填入输入框、自动在ComboBox中选择以及自动点击按钮的情况。</p><h3 id="_4-精确提取数据" tabindex="-1"><a class="header-anchor" href="#_4-精确提取数据" aria-hidden="true">#</a> 4. 精确提取数据</h3><p>仅将有用的数据存储下来才是有意义的。必须研究网页，找出有效数据所在的Tag区（可用文本编辑器或 FrontPage），然后用该对象的innerText属性获得最终的文本。本例中要存储的数据如下图所示，其所用的Tag为“PRE”。</p><p>下面给出的是实例程序的完整代码：</p><div class="language-vb" data-ext="vb"><pre class="language-vb"><code><span class="token comment">&#39; 程序一：从网页上精确提取数据</span>
<span class="token comment">&#39;</span>
<span class="token comment">&#39; 为运行本程序，应在“菜单-&gt;工程-&gt;部件”中添加“Microsoft Internet Controls”</span>
<span class="token comment">&#39; 并在“菜单-&gt;工程-&gt;引用”中添加“Microsoft HTML Object Library”</span>
<span class="token comment">&#39;</span>
<span class="token comment">&#39; 为了简洁，程序仅下载九只个股的基本信息</span>
<span class="token keyword">Option</span> Explicit
<span class="token keyword">Private</span> <span class="token keyword">Const</span> Form_ID <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">Dim</span> Code<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">String</span>
<span class="token keyword">Dim</span> Current <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> Form_Load<span class="token punctuation">(</span><span class="token punctuation">)</span>
  Form1<span class="token punctuation">.</span>MousePointer <span class="token operator">=</span> <span class="token number">11</span>
  <span class="token comment">&#39; 以下是个股代码</span>
  <span class="token comment">&#39; 为了程序简洁，这里仅使用九只代码。</span>
  <span class="token comment">&#39; 而在真实环境中，应从数据文件中读入全部个股代码。</span>
  Code<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&quot;600001&quot;</span><span class="token punctuation">:</span> Code<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&quot;600002&quot;</span><span class="token punctuation">:</span> Code<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&quot;600003&quot;</span>
  Code<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&quot;600005&quot;</span><span class="token punctuation">:</span> Code<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&quot;600006&quot;</span><span class="token punctuation">:</span> Code<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&quot;600007&quot;</span>
  Code<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&quot;600008&quot;</span><span class="token punctuation">:</span> Code<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&quot;600009&quot;</span><span class="token punctuation">:</span> Code<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&quot;600010&quot;</span>
  Current <span class="token operator">=</span> <span class="token number">0</span>
  WebBrowser1<span class="token punctuation">.</span>Navigate <span class="token string">&quot;www.stockstar.com.cn&quot;</span>   <span class="token comment">&#39; 起始网址</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>

<span class="token keyword">Private</span> <span class="token keyword">Sub</span> WebBrowser1_DocumentComplete<span class="token punctuation">(</span>ByValpDisp <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> URL <span class="token keyword">As</span> <span class="token keyword">Variant</span><span class="token punctuation">)</span>
  <span class="token keyword">Dim</span> i<span class="token punctuation">,</span> k
  Text2 <span class="token operator">=</span> WebBrowser1<span class="token punctuation">.</span>LocationURL    <span class="token comment">&#39; 显示当前网址</span>
  <span class="token comment">&#39; 判断当前网页是否全部调入完毕</span>
  <span class="token keyword">If</span> <span class="token keyword">Not</span> <span class="token punctuation">(</span>pDisp <span class="token keyword">Is</span> WebBrowser1<span class="token punctuation">.</span><span class="token keyword">Object</span><span class="token punctuation">)</span> <span class="token keyword">Then</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
  <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">Resume</span> <span class="token keyword">Next</span>
  <span class="token keyword">Select</span> <span class="token keyword">Case</span> Text2
  <span class="token keyword">Case</span> <span class="token string">&quot;http://www.stockstar.com.cn/home.htm&quot;</span>  <span class="token comment">&#39; 当进入主页面时执行以下程序</span>
   <span class="token keyword">For</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">To</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span>Form_ID<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token comment">&#39; 找到代码输入框后填入个股代码</span>
      <span class="token keyword">If</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span>Form_ID<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">&quot;code&quot;</span> <span class="token keyword">Then</span> <span class="token operator">_</span>
        WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span>Form_ID<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> Code<span class="token punctuation">(</span>Current<span class="token punctuation">)</span>
      <span class="token comment">&#39; 在下拉式列表中进行选择</span>
      <span class="token keyword">If</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span>Form_ID<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">&quot;target&quot;</span> <span class="token keyword">Then</span>
        <span class="token keyword">For</span> k <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">To</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span>Form_ID<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
           <span class="token keyword">If</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span>Form_ID<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Options<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">.</span>Text <span class="token operator">_</span>
                     <span class="token operator">=</span> <span class="token string">&quot;个股资料&quot;</span> <span class="token keyword">Then</span>
             WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span>Form_ID<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Options<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">.</span>Selected <span class="token operator">=</span> <span class="token boolean">True</span>
             <span class="token keyword">Exit</span> <span class="token keyword">For</span>
           <span class="token keyword">End</span> <span class="token keyword">If</span>
        <span class="token keyword">Next</span> k
      <span class="token keyword">End</span> <span class="token keyword">If</span>
      <span class="token comment">&#39; 点击按钮</span>
      <span class="token keyword">If</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span>Form_ID<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token string">&quot; 查询 &quot;</span> <span class="token keyword">Then</span> <span class="token operator">_</span>
        WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span>Form_ID<span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Click
   <span class="token keyword">Next</span>
  <span class="token keyword">Case</span> <span class="token keyword">Else</span>   <span class="token comment">&#39; 当进入数据页面时执行以下程序</span>
   <span class="token keyword">For</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">To</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>All<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token keyword">If</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>All<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>tagName <span class="token operator">=</span> <span class="token string">&quot;PRE&quot;</span> <span class="token keyword">Then</span>
        <span class="token comment">&#39; 精确提取数据</span>
        Text1 <span class="token operator">=</span> Text1 <span class="token operator">+</span> Code<span class="token punctuation">(</span>Current<span class="token punctuation">)</span> <span class="token operator">+</span> vbCrLf <span class="token operator">+</span> <span class="token operator">_</span>
                WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>All<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">+</span> vbCrLf
        <span class="token keyword">Exit</span> <span class="token keyword">For</span>
      <span class="token keyword">End</span> <span class="token keyword">If</span>
   <span class="token keyword">Next</span>
   <span class="token comment">&#39; 数据存盘</span>
   Open <span class="token string">&quot;C:\\Data2.Txt&quot;</span> <span class="token keyword">For</span> Append <span class="token keyword">As</span> <span class="token operator">#</span><span class="token number">1</span>
   Print <span class="token operator">#</span><span class="token number">1</span><span class="token punctuation">,</span> Text1<span class="token punctuation">:</span> Text1 <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">:</span> Close <span class="token operator">#</span><span class="token number">1</span>
   <span class="token comment">&#39; 换下一只股票</span>
   Current <span class="token operator">=</span> Current <span class="token operator">+</span> <span class="token number">1</span>
   <span class="token keyword">If</span> Current <span class="token operator">&gt;</span><span class="token operator">=</span> <span class="token number">9</span> <span class="token keyword">Then</span>
     <span class="token comment">&#39; 上网任务完成后，应在此调用自动挂断过程。</span>
     Form1<span class="token punctuation">.</span>MousePointer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">:</span> MsgBox <span class="token string">&quot;Finished!&quot;</span><span class="token punctuation">:</span> <span class="token keyword">End</span>
   <span class="token keyword">End</span> <span class="token keyword">If</span>
   <span class="token comment">&#39; 回退到主页面，查询下一只股票的信息</span>
   WebBrowser1<span class="token punctuation">.</span>GoBack
  <span class="token keyword">End</span> <span class="token keyword">Select</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span> 
</code></pre></div><h2 id="第二部分-将网页上的二维表导入数据库" tabindex="-1"><a class="header-anchor" href="#第二部分-将网页上的二维表导入数据库" aria-hidden="true">#</a> 第二部分 将网页上的二维表导入数据库</h2><p>在上一部分中，我们讨论了让程序自动在网上浏览并将所需的数据准确、快速地存储下来的方法。现在，我们将迎接更大的挑战：将网页上以表格形式存在的二维数据提取出来，并存成可直接导入数据库的“Microsoft Excel 逗号分隔值文件”（即.csv文件）。</p><p><img src="`+e+'" alt="netinter1_3"></p><p>用手工在网页上直接提取类似上图中所示的表格数据是非常困难的。如果这样的表格有数十页甚至上百页之多，手工提取工作将是不可想象的，而且非常容易出错。</p><p>本部分的实例是：将沪深两市全部约1100家个股的财务评分表数据（共54页，每页20家，如上图所示）快速、准确地转换成“.csv”文件。</p><h3 id="_1-自动设置checkbox的值" tabindex="-1"><a class="header-anchor" href="#_1-自动设置checkbox的值" aria-hidden="true">#</a> 1. 自动设置CheckBox的值</h3><p>由于只有注册用户才能访问上述财务评分表，因此实例程序首先演示了自动注册的功能。下图显示的是注册前以及自动注册后的画面。</p><p><img src="'+c+`" alt="netinter1_4"></p><p>我们在上一部分中已讨论了自动填写输入区以及自动点击按钮等的方法。对于自动设置CheckBox值，其方法完全类似：首先要搜索到该CheckBox的名字，然后将该对象的Checked属性置为True或False即可。</p><h3 id="_2-将网页上的二维表导入数据库" tabindex="-1"><a class="header-anchor" href="#_2-将网页上的二维表导入数据库" aria-hidden="true">#</a> 2. 将网页上的二维表导入数据库</h3><p>首先定义一个IHTMLElementCollection对象用于收集网页上所有的 Table，然后用getElementsByTagName方法执行收集工作：</p><div class="language-vb" data-ext="vb"><pre class="language-vb"><code><span class="token keyword">Dim</span> Tables AsIHTMLElementCollection
   <span class="token keyword">Set</span> Tables <span class="token operator">=</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>getElementsByTagName<span class="token punctuation">(</span><span class="token string">&quot;Table&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>一个网页上往往有多个 Table。我们用HTMLTable对象来处理每个Table：</p><div class="language-vb" data-ext="vb"><pre class="language-vb"><code><span class="token keyword">Dim</span> Table1 AsHTMLTable
    <span class="token keyword">For</span> <span class="token keyword">Each</span> Table1 <span class="token keyword">In</span> Tables
    <span class="token keyword">Next</span>
</code></pre></div><p>HTMLTable对象的innerText属性记录了整个 Table的全部信息，包括字段名。因此我们可以根据字段名判断出哪个 Table是我们需要的。</p><p>为了逐行逐列地提取数据，我们还需要HTMLTableRow对象和HTMLTableCell对象：</p><div class="language-vb" data-ext="vb"><pre class="language-vb"><code><span class="token keyword">Dim</span> Row AsHTMLTableRow<span class="token punctuation">,</span> Cell <span class="token keyword">As</span> HTMLTableCell
    <span class="token keyword">For</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">To</span> Table1<span class="token punctuation">.</span>rows<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>      <span class="token comment">&#39; 逐行处理</span>
       <span class="token keyword">Set</span> Row <span class="token operator">=</span> Table1<span class="token punctuation">.</span>rows<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
       j <span class="token operator">=</span> <span class="token number">0</span>
       <span class="token keyword">For</span> <span class="token keyword">Each</span> Cell <span class="token keyword">In</span> Row<span class="token punctuation">.</span>cells      <span class="token comment">&#39; 逐列处理</span>
          <span class="token comment">&#39; Row.cells(j).innerText即为当前行及当前列上的单元数据</span>
          Text1 <span class="token operator">=</span> Text1 <span class="token operator">+</span> Trim<span class="token punctuation">(</span>Row<span class="token punctuation">.</span>cells<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span>
          j <span class="token operator">=</span> j <span class="token operator">+</span> <span class="token number">1</span>
       <span class="token keyword">Next</span>
       <span class="token comment">&#39; 一行处理完毕后，去除行尾的逗号并加上回车</span>
       Text1 <span class="token operator">=</span> Left<span class="token punctuation">(</span>Text1<span class="token punctuation">,</span> Len<span class="token punctuation">(</span>Text1<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> vbCrLf
    <span class="token keyword">Next</span> 
</code></pre></div><p>至此，当前网页上的二维表已转换成“.csv”格式。</p><h3 id="_3-自动浏览时的页面控制技巧" tabindex="-1"><a class="header-anchor" href="#_3-自动浏览时的页面控制技巧" aria-hidden="true">#</a> 3. 自动浏览时的页面控制技巧</h3><p>我们从上个例子中就已经清晰地看到，自动浏览程序的主体是WebBrowser控件的DocumentComplete事件。只有在当前页面已被完全调入后，我们才能开始对当前页面进行数据处理，然后再根据当前在哪个页面来决定下一步的浏览方向。</p><p>需要指出的是，DocumentComplete事件的发生并不一定意味着当前页面已被全部调入。如果页面上没有其它子框架（frames），发生DocumentComplete事件即表明当前页面（即主框架）已完成调入；若页面上有多个框架，则每个框架完成时都会发生DocumentComplete事件；当所有子框架都完成后，主框架最后产生一次DocumentComplete事件。为了判断出这最后一次DocumentComplete事件，需要比较每次事件发生时的对象（pDisp）是否是WebBrowser控件对象本身：</p><div class="language-vb" data-ext="vb"><pre class="language-vb"><code><span class="token keyword">Private</span> <span class="token keyword">Sub</span> WebBrowser1_DocumentComplete<span class="token punctuation">(</span>ByValpDisp <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> <span class="token operator">_</span>
                                             URL <span class="token keyword">As</span> <span class="token keyword">Variant</span><span class="token punctuation">)</span>
      <span class="token keyword">If</span> <span class="token punctuation">(</span>pDisp <span class="token keyword">Is</span> WebBrowser1<span class="token punctuation">.</span><span class="token keyword">Object</span><span class="token punctuation">)</span> <span class="token keyword">Then</span>
        Debug<span class="token punctuation">.</span>Print <span class="token string">&quot;Document is finished loading.&quot;</span>
      <span class="token keyword">End</span> <span class="token keyword">If</span>
    <span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre></div><p>下面是实例程序的完整代码（运行该程序可得到完整的1061行“.csv”格式的数据，分别代表1061个上市公司的财务信息。该文件可直接导入Access数据库或 Excel中。）：</p><div class="language-vb" data-ext="vb"><pre class="language-vb"><code><span class="token comment">&#39; 程序二：将网页上的二维表导入数据库</span>
<span class="token comment">&#39;</span>
<span class="token comment">&#39; 为运行本程序，应在“菜单-&gt;工程-&gt;部件”中添加“Microsoft Internet Controls”</span>
<span class="token comment">&#39; 并在“菜单-&gt;工程-&gt;引用”中添加“Microsoft HTML Object Library”</span>
<span class="token comment">&#39;</span>
<span class="token keyword">Option</span> Explicit
<span class="token keyword">Dim</span> Page <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> Form_Load<span class="token punctuation">(</span><span class="token punctuation">)</span>
Form1<span class="token punctuation">.</span>MousePointer <span class="token operator">=</span> <span class="token number">11</span>
WebBrowser1<span class="token punctuation">.</span>Navigate <span class="token string">&quot;www.stockstar.com.cn&quot;</span> <span class="token comment">&#39; 起始网址</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> WebBrowser1_DocumentComplete<span class="token punctuation">(</span><span class="token keyword">ByVal</span> pDisp <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> URL <span class="token keyword">As</span> <span class="token keyword">Variant</span><span class="token punctuation">)</span>
<span class="token keyword">Dim</span> Table1 <span class="token keyword">As</span> HTMLTable<span class="token punctuation">,</span> Tables <span class="token keyword">As</span> IHTMLElementCollection
<span class="token keyword">Dim</span> Row <span class="token keyword">As</span> HTMLTableRow<span class="token punctuation">,</span> Cell <span class="token keyword">As</span> HTMLTableCell
<span class="token keyword">Dim</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> tmp
Text2 <span class="token operator">=</span> WebBrowser1<span class="token punctuation">.</span>LocationURL <span class="token comment">&#39; 显示当前网址</span>
<span class="token comment">&#39; 判断当前网页是否全部调入完毕</span>
<span class="token keyword">If</span> <span class="token keyword">Not</span> <span class="token punctuation">(</span>pDisp <span class="token keyword">Is</span> WebBrowser1<span class="token punctuation">.</span><span class="token keyword">Object</span><span class="token punctuation">)</span> <span class="token keyword">Then</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
<span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">Resume</span> <span class="token keyword">Next</span>
<span class="token keyword">Select</span> <span class="token keyword">Case</span> Text2
<span class="token keyword">Case</span> <span class="token string">&quot;http://www.stockstar.com.cn/home.htm&quot;</span> <span class="token comment">&#39; 当进入主页面时执行以下程序</span>
<span class="token comment">&#39; 用户注册登录</span>
<span class="token keyword">For</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">To</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
<span class="token comment">&#39; 找到 CheckBox 后，将其值改为 False，以防止用户名及密码被存储</span>
<span class="token keyword">If</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">&quot;checkSavePW&quot;</span> <span class="token keyword">Then</span> <span class="token operator">_</span>
WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Checked <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token keyword">If</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">&quot;userId&quot;</span> <span class="token keyword">Then</span> <span class="token operator">_</span>
WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token string">&quot;kompass_china&quot;</span>
<span class="token keyword">If</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">&quot;passwd&quot;</span> <span class="token keyword">Then</span> <span class="token operator">_</span>
WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token string">&quot;kompass1&quot;</span>
<span class="token comment">&#39; 此处是按名字访问按钮（上例中是按值访问按钮）</span>
<span class="token keyword">If</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">&quot;continue&quot;</span> <span class="token keyword">Then</span> <span class="token operator">_</span>
WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>Forms<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Click
<span class="token keyword">Next</span>
<span class="token keyword">Case</span> <span class="token string">&quot;http://my.stockstar.com/scripts/mystockstar.dll?login&quot;</span>
<span class="token comment">&#39; 当用户登录完成后，准备打开表格的第一页</span>
WebBrowser1<span class="token punctuation">.</span>Navigate <span class="token string">&quot;http://finance.stockstar.com/scripts/finance.dll?&quot;</span> <span class="token operator">+</span> <span class="token operator">_</span>
<span class="token string">&quot;showstkdfpm&amp;begin=0&amp;ret=1&amp;index=2&amp;concode=01&quot;</span>
Page <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">Case</span> <span class="token keyword">Else</span> <span class="token comment">&#39; 当进入数据页面（表格的第一页至最后一页）时执行以下程序</span>
<span class="token keyword">Set</span> Tables <span class="token operator">=</span> WebBrowser1<span class="token punctuation">.</span>Document<span class="token punctuation">.</span>getElementsByTagName<span class="token punctuation">(</span><span class="token string">&quot;Table&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">For</span> <span class="token keyword">Each</span> Table1 <span class="token keyword">In</span> Tables
<span class="token keyword">If</span> Left<span class="token punctuation">(</span>Table1<span class="token punctuation">.</span>innerText<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&quot;名次&quot;</span> <span class="token keyword">Then</span> <span class="token comment">&#39; 找到需要的Table</span>
<span class="token comment">&#39; 将表格转换成“.csv”格式</span>
<span class="token keyword">For</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">To</span> Table1<span class="token punctuation">.</span>rows<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
<span class="token keyword">Set</span> Row <span class="token operator">=</span> Table1<span class="token punctuation">.</span>rows<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
j <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">For</span> <span class="token keyword">Each</span> Cell <span class="token keyword">In</span> Row<span class="token punctuation">.</span>cells
Text1 <span class="token operator">=</span> Text1 <span class="token operator">+</span> Trim<span class="token punctuation">(</span>Row<span class="token punctuation">.</span>cells<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span>
j <span class="token operator">=</span> j <span class="token operator">+</span> <span class="token number">1</span>
<span class="token keyword">Next</span>
Text1 <span class="token operator">=</span> Left<span class="token punctuation">(</span>Text1<span class="token punctuation">,</span> Len<span class="token punctuation">(</span>Text1<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> vbCrLf
<span class="token keyword">Next</span>
<span class="token comment">&#39; 数据存盘</span>
Open <span class="token string">&quot;C:\\Data.csv&quot;</span> <span class="token keyword">For</span> Append <span class="token keyword">As</span> <span class="token operator">#</span><span class="token number">1</span>
Print <span class="token operator">#</span><span class="token number">1</span><span class="token punctuation">,</span> Left<span class="token punctuation">(</span>Text1<span class="token punctuation">,</span> Len<span class="token punctuation">(</span>Text1<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Text1 <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">:</span> Close <span class="token operator">#</span><span class="token number">1</span>
<span class="token keyword">Exit</span> <span class="token keyword">For</span>
<span class="token keyword">End</span> <span class="token keyword">If</span>
<span class="token keyword">Next</span>
<span class="token comment">&#39; 准备打开下一页</span>
Page <span class="token operator">=</span> Page <span class="token operator">+</span> <span class="token number">1</span>
tmp <span class="token operator">=</span> <span class="token string">&quot;http://finance.stockstar.com/scripts/finance.dll?showstkdfpm&amp;ret=&quot;</span> <span class="token operator">+</span> <span class="token operator">_</span>
Trim<span class="token punctuation">(</span>Str<span class="token punctuation">(</span>Page<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&amp;index=2&amp;concode=01&quot;</span>
<span class="token keyword">If</span> Page <span class="token operator">&lt;</span><span class="token operator">=</span> <span class="token number">54</span> <span class="token keyword">Then</span> <span class="token comment">&#39; 判断是否浏览结束</span>
WebBrowser1<span class="token punctuation">.</span>Navigate tmp
<span class="token keyword">Else</span>
<span class="token comment">&#39; 上网任务完成后，应在此调用自动挂断过程。</span>
Form1<span class="token punctuation">.</span>MousePointer <span class="token operator">=</span> <span class="token number">0</span>
MsgBox <span class="token string">&quot;Finished!!&quot;</span><span class="token punctuation">:</span> <span class="token keyword">End</span>
<span class="token keyword">End</span> <span class="token keyword">If</span>
<span class="token keyword">End</span> <span class="token keyword">Select</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span> 
</code></pre></div><p>以下给出的是上述程序所存数据文件的片段：</p><div class="language-txt" data-ext="txt"><pre class="language-txt"><code>1,乐凯胶片,600135,材料,81.493,18.445,23.165,8.850,20.717,10.315
2,歌华有线,600037,传播娱乐,80.553,13.009,22.256,12.141,20.304,12.844
3,外运发展,600270,仓储运输,80.326,17.331,23.005,8.829,19.900,11.261
4,东方钽业,0962,有色金属,80.312,15.160,22.483,11.648,21.290,9.730
5,双汇发展,0895,食品,79.772,15.428,20.673,11.508,20.235,11.930
6,四川美丰,0731,化肥,79.361,15.795,23.235,11.323,16.921,12.088
... ... ...
1059,轮胎橡胶,600623,车类,7.167,8.265,10.973,-34.411,14.120,8.219
1060,PT吉轻工,0546,日用轻工产品,-11.895,5.740,-49.149,7.999,14.136,9.379
1061,广船国际,600685,机械仪器,-57.452,9.824,-1.528,-89.648,14.366,9.533
</code></pre></div><h2 id="第三部分-自动拨号、自动挂断以及自动处理中途掉线" tabindex="-1"><a class="header-anchor" href="#第三部分-自动拨号、自动挂断以及自动处理中途掉线" aria-hidden="true">#</a> 第三部分 自动拨号、自动挂断以及自动处理中途掉线</h2><p>一个出色的“自动上网机器人”程序应能按照既定的时间准时开始拨号、并当所需任务已完成后立即挂断。而且仅做到这些还不够，它还应在发出拨号指令后跟踪拨号操作是否真的成功、上网速度如何、是否需要挂断后重新拨号、自动浏览过程中是否出现掉线、以及最终的挂断操作是否真的成功完成，等等。</p><p>因此，“机器人”程序应定时检查在线状况，以保证浏览时一定在在线状态、浏览完毕后一定不在在线状态。同时还要检查浏览进度，当浏览速度过慢时尝试挂断后重新拨号。</p><p>本部分讨论了实现“自动拨号”、“检查在线状况”、以及“自动挂断”这三个功能的若干方法，比较了诸方法各自的优劣，并总结给出了使用建议。本部分的示例程序将这三个功能的诸方法集成在一起，以便于大家对比使用（见下图）。</p><p><img src="`+k+`" alt="netinter1_5"></p><h3 id="_1-自动拨号" tabindex="-1"><a class="header-anchor" href="#_1-自动拨号" aria-hidden="true">#</a> 1. 自动拨号</h3><h4 id="方法1a-使用rnaui-dll" tabindex="-1"><a class="header-anchor" href="#方法1a-使用rnaui-dll" aria-hidden="true">#</a> 方法1A：使用rnaui.dll</h4><p>rnaui.dll是微软的“拨号网络用户接口”程序集，一般在“\\Windows\\System”目录下。其中的RnaDial程序用于启动拨号。该程序可在命令行执行（在“开始”-&gt;“运行”中键入）：</p><p><code>rundll32.exe rnaui.dll,RnaDial &lt;拨号网络连接名&gt;</code></p><p>其中的“RnaDial”和“&lt;拨号网络连接名&gt;”是区分大小写的。</p><p>但由于上述命令仅启动拨号窗口而未立即开始拨号，因此在程序中使用时还应再</p><p>送出模拟“回车”的按键：</p><div class="language-vb" data-ext="vb"><pre class="language-vb"><code>ret <span class="token operator">=</span> Shell<span class="token punctuation">(</span><span class="token string">&quot;rundll32.exe rnaui.dll,RnaDial &quot;</span> <span class="token operator">+</span> 连接名<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    SendKeys <span class="token string">&quot;{enter}&quot;</span><span class="token punctuation">,</span> <span class="token boolean">True</span>
</code></pre></div><h4 id="方法1b-使用wininet-dll" tabindex="-1"><a class="header-anchor" href="#方法1b-使用wininet-dll" aria-hidden="true">#</a> 方法1B：使用wininet.dll</h4><p>wininet.dll是微软的Internet扩充函数集，一般在“\\Windows\\System”目录下。其中的InternetAutodial、InternetAutodialHangup和InternetGetConnectedState三个函数分别可完成自动拨号、自动挂断和判断在线状态等任务。InternetAutodial的定义为：</p><div class="language-vb" data-ext="vb"><pre class="language-vb"><code><span class="token keyword">Private</span> <span class="token keyword">Declare</span> <span class="token keyword">Function</span> InternetAutodial <span class="token keyword">Lib</span> <span class="token string">&quot;wininet.dll&quot;</span> <span class="token operator">_</span>
           <span class="token punctuation">(</span>ByValdwFlags <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">,</span> ByValdwReserved <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Long</span>
</code></pre></div><p>若将第一个参数（dwFlags）的值设为2，该函数无需用户干预就可自动拨号。但使用该函数有一个前提：即必须将“Internet 属性”-&gt;“连接”设成“始终拨打默认连接”（见下图）。</p><p><img src="`+l+'" alt="netinter1_6"></p><p>用InternetAutodial函数自动拨号的情况可参见下图。从图中可以看出，该方法可自动重试多次。具体的重试次数在默认连接的“设置”-&gt;“高级”中定义：</p><p><img src="'+r+'" alt="netinter1_7"></p><h4 id="方法1c-使用ras" tabindex="-1"><a class="header-anchor" href="#方法1c-使用ras" aria-hidden="true">#</a> 方法1C：使用RAS</h4><p>RAS 是微软的远程访问服务（Remote Access Service）API集合。其中的 API函数RasDial可完成拨号任务。但由于该函数在使用上略显复杂而不太常用，故示例程序中未采纳。</p><p>自动拨号方法小结：rnaui方法使用起来最简单，又由于它不一定非要使用默认连接，因此也最灵活。但这种灵活恰恰又给它带来了弱点，即如果不提供连接名，该方法不会自动调用默认连接。此外，这种方法还有两个最大的缺点：一是仅拨号一次，若出现占线或没有响应等情况时不会自动重试；二是调用程序不容易得到拨号是否成功的返回值。相比之下，wininet方法虽仅能拨打默认连接（无默认连接时，使用第一个连接），但它可多次试拨，并且InternetAutodial函数等待拨号成功或所有试拨结束以便给调用程序返回拨号是否成功的值，因此，在“自动上网机器人”的环境中wininet方法是最适宜的。</p><h3 id="_2-检查在线状况" tabindex="-1"><a class="header-anchor" href="#_2-检查在线状况" aria-hidden="true">#</a> 2. 检查在线状况</h3><h4 id="方法2a-wininet方法" tabindex="-1"><a class="header-anchor" href="#方法2a-wininet方法" aria-hidden="true">#</a> 方法2A：wininet方法</h4><p>若InternetGetConnectedState函数返回True，则为在线状态。该方法最大的缺点是：若当前连接不是用wininet方法建立的，则返回值可能不准确。</p><h4 id="方法2b-查找窗口法" tabindex="-1"><a class="header-anchor" href="#方法2b-查找窗口法" aria-hidden="true">#</a> 方法2B：查找窗口法</h4><p>拨号连接成功后，下图所示的窗口一定存在（不管它是最小化在任务栏的最右端，或是开启为下图所示的状态）：</p><p><img src="'+u+`" alt="netinter1_8"></p><p>用FindWindow API函数找到该窗口即意味着当前在线。此外，查找窗口法的另一个用处是查找“重新连接”窗口：当中途掉线时，操作系统往往会询问你是否重新连接，找到该窗口并发出模拟“回车”按键即可实现再拨号。</p><p>查找窗口法的缺点是：由于找窗口时需要提供窗口标题，因此即使使用的是默认连接也必须事先知道默认连接名。</p><h4 id="方法2c-ras-方法" tabindex="-1"><a class="header-anchor" href="#方法2c-ras-方法" aria-hidden="true">#</a> 方法2C：RAS 方法</h4><p>先用RasEnumConnections函数返回整个RAS集合，再用RasGetConnectStatus函数判断第一个 RAS连接的状态。RAS方法的最大优点是：不管当前连接是否是用wininet建立的，RAS 方法均可对在线状态做出正确判断。</p><h4 id="方法2d-注册表法" tabindex="-1"><a class="header-anchor" href="#方法2d-注册表法" aria-hidden="true">#</a> 方法2D：注册表法</h4><p>在线时，注册表的“\\HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Services\\RemoteAccess”处有键值“Remote Connection”，且其值不为零；不在线时，该处无“Remote Connection”键值（当本次系统启动后从未拨号成功时），或者其值为零（表明曾拨号成功，但现在已断掉）。</p><p>检查在线状况之方法小结：由于wininet方法的局限性，一般我们应避免使用之；查找窗口法是可靠的，只是要知道连接名；因此我们推荐使用RAS 方法和注册表法。</p><h3 id="_3-自动挂断" tabindex="-1"><a class="header-anchor" href="#_3-自动挂断" aria-hidden="true">#</a> 3. 自动挂断</h3><h4 id="方法3a-wininet法" tabindex="-1"><a class="header-anchor" href="#方法3a-wininet法" aria-hidden="true">#</a> 方法3A：wininet法</h4><p>使用InternetAutodialHangup函数。同样地，若当前连接不是用wininet方法建立的，则返回值可能不准确（即不能成功挂断）。</p><h4 id="方法3b-窗口查找法" tabindex="-1"><a class="header-anchor" href="#方法3b-窗口查找法" aria-hidden="true">#</a> 方法3B：窗口查找法</h4><p>找到图九所示的窗口，然后用ShowWindow API函数使之成为当前窗口，最后发出模拟<code>&lt;Alt&gt;+C</code>的按键操作（从图九中可以看出，<code>&lt;Alt&gt;+C</code>是“断开连接”按键的快捷方式）。</p><h4 id="方法3c-ras-法" tabindex="-1"><a class="header-anchor" href="#方法3c-ras-法" aria-hidden="true">#</a> 方法3C：RAS 法</h4><p>用RasHangUp函数执行挂断。不管用何种方法建立的连接，RAS 法均能可靠地完成任务。</p><p>自动挂断方法小结：相比之下，窗口查找法和RAS 法是可以信赖的。</p><h3 id="_4-本部分总结" tabindex="-1"><a class="header-anchor" href="#_4-本部分总结" aria-hidden="true">#</a> 4. 本部分总结</h3><p>综上所述，对于“自动拨号”、“检查在线状况”、以及“自动挂断”的各种方法，我们推荐“1A-2C-3C”组合。当然各方法可综合使用（如加入2D、3B等），以确保万无一失。在具体编程时还应注意：拨号后判断结果，如不成功应重新拨号；任务进行过程中定时检查在线状态，出现掉线后应及时处理；最后的挂断操作后应再查在线状态，以确保挂断成功。</p><p>下面是实例程序的完整代码。源代码中的全局定义已按照wininet、RAS、注册表等进行分类，各具体方法也均按序排列，以便于大家挑选使用。该程序的执行情况在本部分的开始处已给出（图六）。</p><div class="language-vb" data-ext="vb"><pre class="language-vb"><code><span class="token comment">&#39; 程序三：自动拨号、自动挂断以及自动处理中途掉线</span>
<span class="token comment">&#39;</span>
<span class="token keyword">Option</span> Explicit
<span class="token comment">&#39; 有关 wininet 的全局定义</span>
<span class="token keyword">Private</span> <span class="token keyword">Const</span> INTERNET_AUTODIAL_FORCE_UNATTENDED <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">Private</span> <span class="token keyword">Const</span> INTERNET_CONNECTION_MODEM <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">Private</span> <span class="token keyword">Declare</span> <span class="token keyword">Function</span> InternetAutodial <span class="token keyword">Lib</span> <span class="token string">&quot;wininet.dll&quot;</span> <span class="token operator">_</span>
<span class="token punctuation">(</span><span class="token keyword">ByVal</span> dwFlags <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">,</span> <span class="token keyword">ByVal</span> dwReserved <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token keyword">Private</span> <span class="token keyword">Declare</span> <span class="token keyword">Function</span> InternetAutodialHangup <span class="token keyword">Lib</span> <span class="token operator">_</span>
<span class="token string">&quot;wininet.dll&quot;</span> <span class="token punctuation">(</span><span class="token keyword">ByVal</span> dwReserved <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token keyword">Private</span> <span class="token keyword">Declare</span> <span class="token keyword">Function</span> InternetGetConnectedState <span class="token keyword">Lib</span> <span class="token operator">_</span>
<span class="token string">&quot;wininet.dll&quot;</span> <span class="token punctuation">(</span><span class="token keyword">ByRef</span> lpdwFlags <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">,</span> <span class="token keyword">ByVal</span> <span class="token operator">_</span>
dwReserved <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token comment">&#39; 有关“窗口查找”的全局定义</span>
<span class="token keyword">Private</span> <span class="token keyword">Declare</span> <span class="token keyword">Function</span> FindWindow <span class="token keyword">Lib</span> <span class="token string">&quot;user32&quot;</span> <span class="token operator">_</span>
<span class="token keyword">Alias</span> <span class="token string">&quot;FindWindowA&quot;</span> <span class="token punctuation">(</span><span class="token keyword">ByVal</span> lpClassName <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">,</span> <span class="token operator">_</span>
<span class="token keyword">ByVal</span> lpWindowName <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token keyword">Private</span> <span class="token keyword">Declare</span> <span class="token keyword">Function</span> ShowWindow <span class="token keyword">Lib</span> <span class="token string">&quot;user32&quot;</span> <span class="token operator">_</span>
<span class="token punctuation">(</span><span class="token keyword">ByVal</span> hwnd <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">,</span> <span class="token keyword">ByVal</span> nCmdShow <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token keyword">Private</span> <span class="token keyword">Const</span> SW_SHOW <span class="token operator">=</span> <span class="token number">5</span>
<span class="token comment">&#39; 有关 RAS 的全局定义</span>
<span class="token keyword">Private</span> <span class="token keyword">Const</span> RASCS_DONE <span class="token operator">=</span> <span class="token number">&amp;H2000</span><span class="token operator">&amp;</span>
<span class="token keyword">Private</span> <span class="token keyword">Const</span> RAS_MaxEntryName <span class="token operator">=</span> <span class="token number">256</span>
<span class="token keyword">Private</span> <span class="token keyword">Const</span> RAS_MaxDeviceType <span class="token operator">=</span> <span class="token number">16</span>
<span class="token keyword">Private</span> <span class="token keyword">Const</span> RAS_MaxDeviceName <span class="token operator">=</span> <span class="token number">128</span>
<span class="token keyword">Private</span> <span class="token keyword">Type</span> RASCONN
dwSize <span class="token keyword">As</span> <span class="token keyword">Long</span>
hRasConn <span class="token keyword">As</span> <span class="token keyword">Long</span>
szEntryName<span class="token punctuation">(</span>RAS_MaxEntryName<span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Byte</span>
szDeviceType<span class="token punctuation">(</span>RAS_MaxDeviceType<span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Byte</span>
szDeviceName<span class="token punctuation">(</span>RAS_MaxDeviceName<span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Byte</span>
<span class="token keyword">End</span> <span class="token keyword">Type</span>
<span class="token keyword">Private</span> <span class="token keyword">Type</span> RASCONNSTATUS
dwSize <span class="token keyword">As</span> <span class="token keyword">Long</span>
RasConnState <span class="token keyword">As</span> <span class="token keyword">Long</span>
dwError <span class="token keyword">As</span> <span class="token keyword">Long</span>
szDeviceType<span class="token punctuation">(</span>RAS_MaxDeviceType<span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Byte</span>
szDeviceName<span class="token punctuation">(</span>RAS_MaxDeviceName<span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Byte</span>
<span class="token keyword">End</span> <span class="token keyword">Type</span>
<span class="token keyword">Private</span> Ras_Buf<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">As</span> RASCONN
<span class="token keyword">Private</span> Ras_Status <span class="token keyword">As</span> RASCONNSTATUS
<span class="token keyword">Private</span> lpcb <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token keyword">Private</span> lpcConnections <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token keyword">Private</span> <span class="token keyword">Declare</span> <span class="token keyword">Function</span> RasEnumConnections <span class="token keyword">Lib</span> <span class="token operator">_</span>
<span class="token string">&quot;rasapi32.dll&quot;</span> <span class="token keyword">Alias</span> <span class="token string">&quot;RasEnumConnectionsA&quot;</span> <span class="token punctuation">(</span>lprasconn <span class="token operator">_</span>
<span class="token keyword">As</span> Any<span class="token punctuation">,</span> lpcb <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">,</span> lpcConnections <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token keyword">Private</span> <span class="token keyword">Declare</span> <span class="token keyword">Function</span> RasGetConnectStatus <span class="token keyword">Lib</span> <span class="token operator">_</span>
<span class="token string">&quot;rasapi32.dll&quot;</span> <span class="token keyword">Alias</span> <span class="token string">&quot;RasGetConnectStatusA&quot;</span> <span class="token punctuation">(</span><span class="token keyword">ByVal</span> <span class="token operator">_</span>
hRasConn <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">,</span> lpRASCONNSTATUS <span class="token keyword">As</span> Any<span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token keyword">Private</span> <span class="token keyword">Declare</span> <span class="token keyword">Function</span> RasHangUp <span class="token keyword">Lib</span> <span class="token string">&quot;rasapi32.dll&quot;</span> <span class="token operator">_</span>
<span class="token keyword">Alias</span> <span class="token string">&quot;RasHangUpA&quot;</span> <span class="token punctuation">(</span><span class="token keyword">ByVal</span> hRasConn <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token comment">&#39; 有关“注册表”的全局定义</span>
<span class="token keyword">Private</span> <span class="token keyword">Const</span> HKEY_LOCAL_MACHINE <span class="token operator">=</span> <span class="token number">&amp;H80000002</span>
<span class="token keyword">Private</span> <span class="token keyword">Declare</span> <span class="token keyword">Function</span> RegOpenKey <span class="token keyword">Lib</span> <span class="token string">&quot;advapi32.dll&quot;</span> <span class="token keyword">Alias</span> <span class="token operator">_</span>
<span class="token string">&quot;RegOpenKeyA&quot;</span> <span class="token punctuation">(</span><span class="token keyword">ByVal</span> hKey <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">,</span> <span class="token keyword">ByVal</span> lpSubKey <span class="token keyword">As</span> <span class="token operator">_</span>
<span class="token keyword">String</span><span class="token punctuation">,</span> phkResult <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token keyword">Private</span> <span class="token keyword">Declare</span> <span class="token keyword">Function</span> RegQueryValueEx <span class="token keyword">Lib</span> <span class="token string">&quot;advapi32.dll&quot;</span> <span class="token operator">_</span>
<span class="token keyword">Alias</span> <span class="token string">&quot;RegQueryValueExA&quot;</span> <span class="token punctuation">(</span><span class="token keyword">ByVal</span> hKey <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">,</span> <span class="token keyword">ByVal</span> <span class="token operator">_</span>
lpValueName <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">,</span> <span class="token keyword">ByVal</span> lpReserved <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">,</span> lpType <span class="token operator">_</span>
<span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">,</span> lpData <span class="token keyword">As</span> Any<span class="token punctuation">,</span> lpcbData <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token keyword">Private</span> <span class="token keyword">Declare</span> <span class="token keyword">Function</span> RegCloseKey <span class="token keyword">Lib</span> <span class="token string">&quot;advapi32.dll&quot;</span> <span class="token operator">_</span>
<span class="token punctuation">(</span><span class="token keyword">ByVal</span> hKey <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token keyword">Dim</span> ret <span class="token keyword">As</span> <span class="token keyword">Long</span>
<span class="token comment">&#39;自动拨号</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> wininet拨号测试_Click<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">If</span> InternetAutodial<span class="token punctuation">(</span>INTERNET_AUTODIAL_FORCE_UNATTENDED<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">_</span>
<span class="token keyword">Then</span> MsgBox <span class="token string">&quot;已连接（wininet法）&quot;</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> rnaui拨号测试_Click<span class="token punctuation">(</span><span class="token punctuation">)</span>
ret <span class="token operator">=</span> Shell<span class="token punctuation">(</span><span class="token string">&quot;rundll32.exe rnaui.dll,RnaDial &quot;</span> <span class="token operator">+</span> Text1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span> DoEvents
SendKeys <span class="token string">&quot;{enter}&quot;</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">:</span> DoEvents
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
<span class="token comment">&#39;检查是否断线</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> wininet方法_Click<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">&#39; wininet法检查是否断线</span>
<span class="token keyword">If</span> InternetGetConnectedState<span class="token punctuation">(</span>INTERNET_CONNECTION_MODEM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">Then</span>
MsgBox <span class="token string">&quot;在线．&quot;</span>
<span class="token keyword">Else</span>
MsgBox <span class="token string">&quot;当前未连接。&quot;</span>
<span class="token keyword">End</span> <span class="token keyword">If</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> 查找窗口法_Click<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">&#39; 查找窗口法检查是否断线</span>
ret <span class="token operator">=</span> FindWindow<span class="token punctuation">(</span><span class="token string">&quot;#32770&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;重新连接&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">If</span> ret <span class="token operator">&lt;</span><span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>
<span class="token keyword">Call</span> ShowWindow<span class="token punctuation">(</span>ret<span class="token punctuation">,</span> SW_SHOW<span class="token punctuation">)</span>
SendKeys <span class="token string">&quot;{enter}&quot;</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">:</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
<span class="token keyword">End</span> <span class="token keyword">If</span>
ret <span class="token operator">=</span> FindWindow<span class="token punctuation">(</span><span class="token string">&quot;#32770&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;连接到 The95963&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">If</span> ret <span class="token operator">&lt;</span><span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>
MsgBox <span class="token string">&quot;在线．&quot;</span>
<span class="token keyword">Else</span>
MsgBox <span class="token string">&quot;当前未连接。&quot;</span>
<span class="token keyword">End</span> <span class="token keyword">If</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> RAS方法_Click<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">&#39; RAS方法检查是否断线</span>
Ras_Buf<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dwSize <span class="token operator">=</span> Len<span class="token punctuation">(</span>Ras_Buf<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
lpcb <span class="token operator">=</span> <span class="token number">256</span> <span class="token operator">*</span> Ras_Buf<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dwSize
ret <span class="token operator">=</span> RasEnumConnections<span class="token punctuation">(</span>Ras_Buf<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lpcb<span class="token punctuation">,</span> lpcConnections<span class="token punctuation">)</span>
<span class="token keyword">If</span> ret <span class="token keyword">Then</span>
MsgBox <span class="token string">&quot;出错！&quot;</span><span class="token punctuation">:</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
<span class="token keyword">End</span> <span class="token keyword">If</span>
Ras_Status<span class="token punctuation">.</span>dwSize <span class="token operator">=</span> Len<span class="token punctuation">(</span>Ras_Status<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span>
ret <span class="token operator">=</span> RasGetConnectStatus<span class="token punctuation">(</span>Ras_Buf<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hRasConn<span class="token punctuation">,</span> Ras_Status<span class="token punctuation">)</span>
<span class="token keyword">If</span> ret <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">And</span> Ras_Status<span class="token punctuation">.</span>RasConnState <span class="token operator">=</span> RASCS_DONE <span class="token keyword">Then</span>
MsgBox <span class="token string">&quot;在线．&quot;</span>
<span class="token keyword">Else</span>
MsgBox <span class="token string">&quot;当前未连接。&quot;</span>
<span class="token keyword">End</span> <span class="token keyword">If</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> 注册表法_Click<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">&#39; 注册表法检查是否断线</span>
<span class="token keyword">Dim</span> SubKey <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">,</span> ValueName <span class="token keyword">As</span> <span class="token keyword">String</span>
<span class="token keyword">Dim</span> Data <span class="token keyword">As</span> <span class="token keyword">Long</span><span class="token punctuation">,</span> Result <span class="token keyword">As</span> <span class="token keyword">Long</span>
SubKey <span class="token operator">=</span> <span class="token string">&quot;System\\CurrentControlSet\\Services\\RemoteAccess&quot;</span>
ret <span class="token operator">=</span> RegOpenKey<span class="token punctuation">(</span>HKEY_LOCAL_MACHINE<span class="token punctuation">,</span> SubKey<span class="token punctuation">,</span> Result<span class="token punctuation">)</span>
<span class="token keyword">If</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token operator">&amp;</span> <span class="token keyword">Then</span>
ValueName <span class="token operator">=</span> <span class="token string">&quot;Remote Connection&quot;</span>
ret <span class="token operator">=</span> RegQueryValueEx<span class="token punctuation">(</span>Result<span class="token punctuation">,</span> ValueName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token keyword">ByVal</span> Data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&amp;</span><span class="token punctuation">)</span>
ret <span class="token operator">=</span> RegQueryValueEx<span class="token punctuation">(</span>Result<span class="token punctuation">,</span> ValueName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">&amp;</span><span class="token punctuation">,</span> Data<span class="token punctuation">,</span> Len<span class="token punctuation">(</span>Data<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">If</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token operator">&amp;</span> <span class="token keyword">And</span> Data <span class="token operator">&lt;</span><span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>
MsgBox <span class="token string">&quot;在线！&quot;</span>
<span class="token keyword">Else</span>
MsgBox <span class="token string">&quot;当前未连接。&quot;</span>
<span class="token keyword">End</span> <span class="token keyword">If</span>
RegCloseKey <span class="token punctuation">(</span>Result<span class="token punctuation">)</span>
<span class="token keyword">End</span> <span class="token keyword">If</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
<span class="token comment">&#39;自动挂断</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> wininet法_Click<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">&#39; wininet法自动挂断</span>
<span class="token keyword">If</span> InternetAutodialHangup<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">Then</span> MsgBox <span class="token string">&quot;已挂断（wininet法）&quot;</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> 窗口查找法_Click<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">&#39; 窗口查找法自动挂断</span>
ret <span class="token operator">=</span> FindWindow<span class="token punctuation">(</span><span class="token string">&quot;#32770&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;连接到 The95963&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">If</span> ret <span class="token operator">&lt;</span><span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">Then</span>
<span class="token keyword">Call</span> ShowWindow<span class="token punctuation">(</span>ret<span class="token punctuation">,</span> SW_SHOW<span class="token punctuation">)</span>
SendKeys <span class="token string">&quot;%c&quot;</span><span class="token punctuation">,</span> <span class="token boolean">True</span>
MsgBox <span class="token string">&quot;已挂断（窗口查找法）&quot;</span>
<span class="token keyword">End</span> <span class="token keyword">If</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
<span class="token keyword">Private</span> <span class="token keyword">Sub</span> RAS法_Click<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">&#39; RAS法自动挂断</span>
Ras_Buf<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dwSize <span class="token operator">=</span> Len<span class="token punctuation">(</span>Ras_Buf<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
lpcb <span class="token operator">=</span> <span class="token number">256</span> <span class="token operator">*</span> Ras_Buf<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dwSize
ret <span class="token operator">=</span> RasEnumConnections<span class="token punctuation">(</span>Ras_Buf<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lpcb<span class="token punctuation">,</span> lpcConnections<span class="token punctuation">)</span>
<span class="token keyword">If</span> ret <span class="token keyword">Then</span>
MsgBox <span class="token string">&quot;出错！&quot;</span><span class="token punctuation">:</span> <span class="token keyword">Exit</span> <span class="token keyword">Sub</span>
<span class="token keyword">End</span> <span class="token keyword">If</span>
Ras_Status<span class="token punctuation">.</span>dwSize <span class="token operator">=</span> Len<span class="token punctuation">(</span>Ras_Status<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span>
ret <span class="token operator">=</span> RasGetConnectStatus<span class="token punctuation">(</span>Ras_Buf<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hRasConn<span class="token punctuation">,</span> Ras_Status<span class="token punctuation">)</span>
<span class="token keyword">If</span> ret <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">And</span> Ras_Status<span class="token punctuation">.</span>RasConnState <span class="token operator">=</span> RASCS_DONE <span class="token keyword">Then</span>
<span class="token keyword">If</span> RasHangUp<span class="token punctuation">(</span>Ras_Buf<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hRasConn<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">Then</span> <span class="token operator">_</span>
MsgBox <span class="token string">&quot;已挂断（RAS法）&quot;</span>
<span class="token keyword">End</span> <span class="token keyword">If</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span> 
</code></pre></div><hr><hr><p>对该文的评论 人气：7171</p><p>amna(2003-11-2 12:53:41)</p><blockquote><p>关注到第一部分第3点：自动点击按钮。如果不是按钮，而是一个超级连接（links），好像就没有click方法，我查了webbrowser控件说明，就是找不到&lt;A&gt;元素的方法，哪位可以提供相关资料？（因为有些网页包含了参数传送，不能直接用WebBrowser1.Navigate方法进入连接）</p></blockquote><p>lovegsw(2003-7-3 15:08:27)</p><blockquote><p>好象是不错。我看看试试！</p></blockquote><p>cocosoft(2003-5-20 20:40:45)</p><blockquote><p>收藏先！</p></blockquote><p>badman911(2003-5-9 16:51:15)</p><blockquote><p>收藏</p></blockquote><p>allanyan(2003-5-5 17:07:52)</p><blockquote><p>经典</p></blockquote><p>kissoflife(2003-4-17 10:09:06)</p><blockquote><p>收藏</p></blockquote><p>dumax__2002(2003-4-7 10:53:09)</p><blockquote><p>让我想起了《黑客帝国》</p></blockquote><p>asialove2003(2003-4-6 14:29:51)</p><blockquote><p>其实就是个爱好吧<br><br> 我自己一般都是花钱买的。象web data explore, AEE, AMV 等等<br><br> 40-90 美圆一个，自己做的都是为了切实的特别需要！我有个东西，只要别人的站点有新用户加了进来，他就会把新用户给我发过来！（实际上还是抓取的）<br><br> 很简单！不过没有人做这样的东西来卖，只要自己做!</p></blockquote><p>superworker(2003-4-6 11:22:35)</p><blockquote><p>上一贴子介绍的过滤器的使用例子.<br> 1.广告图片太多.则在设置文件里面添加去掉图片的设置条目,可以完全就把图片滤除,也可以让图片滤除后显示一个具有一定提示意义的简短连接.这样,在访问网站取回页面后,图片就没有了.<br> 2.FLASH动画有时候是非常令人讨厌的东西.和上面讲的图片过滤设置方法一样.让FLASH在自己有闲心观看的时候,单独在一个窗口里面跑动吧.<br> 3.页面的北京太艳丽,很容易让自己的上司发现自己在上网.那么在设置文件里面添加一个将背景全部设置为白色的设置条目就可以了.(我本人现在就这么干的)<br><br> 上述所有的设置都通过浏览器可以完成,因为该过滤软件内嵌一个支持CGI开发的WEB服务器,所有的管理功能都将通过该WEB服务器完成.<br><br> 如果你的朋友希望与你分享过滤功能的话,那么,请为他开设一个帐号,让他把他的浏览器的代理指向你的过滤器就可以了.同时,他因为有自己的帐号,所以可以有自己喜欢的过滤方式.</p></blockquote><p>superworker(2003-4-6 11:08:14)</p><blockquote><p>目前正在做一个网页过滤器.目标是在用户可以控制的情况下过滤掉所有的图片或别的用户希望过滤的内容.基本思路是:<br> 1.系统作为一个WEB代理启动<br> 2.启动起来后,修改浏览器的代理设置,指向自己的代理<br> 3.代理浏览器取回页面<br> 4.如果取会的页面是HTML页面,则扫描该页面,根据用户的设置将需要过滤的内容过滤掉,或留下一个简短的指向被过滤的内容的连接.(这样一来用户可以点击该连接在新的窗口里面单独浏览该内容)<br><br> 上述功能目前已经实现了绝大部分,但是,要真正完全过滤掉试图过滤的所有内容,还需要对JAVASCRIPT进行解释,因为如果有些内容不是直接用HTML标签而是通过JAVASCRIPT的打印语句输出的话,对该部分的过滤就存在问题.<br> 目前正在思考实现JAVASCRIPT解释的问题.欢迎有兴趣的朋友给点建议.</p></blockquote><p>hpn_cao(2003-4-6 10:06:29)</p><blockquote><p>这种软件网上都一堆了，功能强大很多呢：<br> http://www.youthinfo.biz/DetailProduct.asp?id=1<br> 据说百度也有相关产品。</p></blockquote><p>bluemouse(2003-4-5 22:39:35)</p><blockquote><p>Netcull的内容抓取已经作出来了，但是由于版权等等问题没有公开提供访问，大家如果要看这个功能，我可以提供试用帐号，呵呵。</p></blockquote><p>asialove2003(2003-4-5 7:19:30)</p><blockquote><p>当form load<br><br> list1.additem (所有股票代码)<br><br> webbrowser 可以去按照list item 去explore<br><br> 不过EXCEL 2000 里面的web query 够强大的！<br><br> 谁知道怎么可以让excel 批量的query</p></blockquote><p>asialove2003(2003-4-5 7:17:42)</p><blockquote></blockquote><div class="language-vb" data-ext="vb"><pre class="language-vb"><code><span class="token keyword">Dim</span> Table1 AsHTMLTable
    <span class="token keyword">For</span> <span class="token keyword">Each</span> Table1 <span class="token keyword">In</span> Tables
    <span class="token keyword">Next</span>
</code></pre></div><blockquote><p>这里可以用table.lenth 来获取一共有多少个table</p></blockquote><p>Spring414(2003-4-4 18:35:43)</p><blockquote><p>child_bj: 你用BCB做做么？可以看看你的作品吗？</p></blockquote><p>hbb1981(2003-4-4 14:38:59)</p><blockquote><p>收藏</p></blockquote><p>shines(2003-4-4 13:47:02)</p><blockquote><p>还有，就像楼下的人说，抓回来的数据肯定不能跟别人的组织一样，肯定要经过自己的模板配合抓回来的数据重新组合为新的页面。</p></blockquote><p>shines(2003-4-4 13:45:20)</p><blockquote><p>初看满好，细看其实不怎么样，不过能用VB这样做已经是很了不起了，其实HTML定位是很麻烦的，文中是依靠Table的name才判断位置的，要是人家Table没有定义Name或ID就没折了，我做过更好的，而且重要的一点就是，如果网速慢的时候可以使用代理来访问所要的数据。不过文中提供的方法也不失为一种很特别的方法。</p></blockquote><p>oldgameman(2003-4-4 13:08:26)</p><blockquote><p>太棒了<br> 关于如何从网页中自动索取特定的信息，一直是我想了解的。<br> 这可是编写自己的机器人的基本功能啊。<br> 收藏先^_^</p></blockquote><p>wwqq2(2003-4-4 10:36:45)</p><blockquote><p>WEBPRINT组件用于在B/S下实现打印功能,具有安全性好,参数简单,使用方便的特点.<br> e表用于在B/S下实现各种各样的报表设计功能.是一个报表框架.使用它可大大加快查询统计报表的开发.这两个组件都提供100%源程序及相关开发文档.<br><br> 可到下列地址下载演示版及详细说明:<br> http://www.fcsoft.com.cn<br> http://218.30.21.125:8084/friendmake/softwaredevelope/eReport.zip<br> http://211.92.204.3:8089/friendmake/softwaredevelope/eReport.zip<br><br> 在浏览器中实现打印,套打的完美解决方案.<br> 参见http://www.fcsoft.com.cn</p></blockquote><p>bluemouse(2003-4-3 23:39:09)</p><blockquote><p>to：hsn1982，如果让程序全自动分析太难了，从某种意义上来讲，属于人工智能的范畴了，呵呵。</p></blockquote><p>bluemouse(2003-4-3 23:38:08)</p><blockquote><p>netcull正文抓取已经实现了，但是由于版权问题没敢放在前台而已。这个系统就是我作的，有问题我们可以随时沟通的，我的QQ：109228</p></blockquote><p>white(2003-4-3 17:52:46)</p><blockquote><p>en，对，就是要像 netcull.com那样的，而且正文内容也要抓过来，而且取出正文等有效信息，然后重新套自己的模板来发布。<br> 客户的要求是不是有些变态啊，我找了半天，也没找到相关资料。</p></blockquote><p>bluemouse(2003-4-3 13:20:40)</p><blockquote><p>看一下netcull.com，采用的技术类似white所描述的那种，其中对html纠错的部分占整个代码量的8成以上。</p></blockquote><p>white(2003-4-3 9:47:17)</p><blockquote><p>自动填写值是没必要，用HTTP协议的POST或GET就可以了。<br> 我最近也在做类似的项目，但是要通用的，就是说提供一个工具来允许用户设置要抓取网页中什么位置的什么内容，甚至要顺着连接将具体内容也抓下来。<br> 想了半天，还没找到一个好的模型，因为HTML的语法是不规范的。</p></blockquote><p>child_bj(2003-4-2 20:35:26)</p><blockquote><p>我用BCB做过</p></blockquote><p>fangcheng(2003-4-2 15:04:01)</p><blockquote><p>up</p></blockquote><p>albert_qhd(2003-4-2 13:42:20)</p><blockquote><p>好像不需要自动填写值吧？<br> 只要将数据通过post或get传到指定页就行了吧？</p></blockquote><p>mwjx(2003-4-2 1:18:51)</p><blockquote><p>good</p></blockquote><p>yinjinbin(2003-4-1 23:51:11)</p><blockquote><p>感觉还不错。<br> 不知用起来如何啊！</p></blockquote><p>qxm(2003-4-1 14:03:32)</p><blockquote><p>不错，不知道使用起来效果怎么样，有没有已经做好的VB工程啊？</p></blockquote><p>jishufenxi(2003-4-1 12:15:38)</p><blockquote><p>gz</p></blockquote><p>01Soft(2003-4-1 12:01:51)</p><blockquote><p>收藏，好好研读研读！</p></blockquote>`,169),w=[d];function y(b,m){return s(),a("div",null,w)}const h=n(i,[["render",y],["__file","netinter1.html.vue"]]);export{h as default};
